name: Manual Server Pack Build

on:
  workflow_dispatch:     # Manual trigger
    inputs:
      force_version:
        description: 'Force build specific version (optional)'
        required: false

env:
  MODRINTH_PROJECT_SLUG: "okicraft"
  MINECRAFT_VERSION: "1.20.1"
  FORGE_VERSION: "47.2.0"
  PACK_NAME: "OKICRAFT"

jobs:
  fetch-version-info:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_info.outputs.version }}
      mrpack_url: ${{ steps.get_info.outputs.mrpack_url }}
    steps:
      - name: Get Modrinth Info
        id: get_info
        run: |
          # 1. Get latest version from Modrinth API
          echo "Fetching latest version from Modrinth..."
          RESPONSE=$(curl -s "https://api.modrinth.com/v2/project/${{ env.MODRINTH_PROJECT_SLUG }}/version")
          
          # Parse JSON for latest version number and file URL
          LATEST_VER=$(echo "$RESPONSE" | jq -r '.[0].version_number')
          MRPACK_URL=$(echo "$RESPONSE" | jq -r '.[0].files[] | select(.primary==true) | .url')
          
          if [ "$LATEST_VER" == "null" ] || [ -z "$LATEST_VER" ]; then
            echo "::error::Could not fetch version from Modrinth."
            exit 1
          fi
          
          echo "Latest Modrinth Version: $LATEST_VER"
          echo "version=$LATEST_VER" >> $GITHUB_OUTPUT
          echo "mrpack_url=$MRPACK_URL" >> $GITHUB_OUTPUT

  build-server-pack:
    needs: fetch-version-info
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Needed to create releases
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq unzip curl

      - name: Setup Environment
        run: |
          echo "VERSION=${{ needs.fetch-version-info.outputs.version }}" >> $GITHUB_ENV
          echo "MRPACK_URL=${{ needs.fetch-version-info.outputs.mrpack_url }}" >> $GITHUB_ENV

      - name: Download and extract mrpack
        run: |
          echo "Downloading mrpack from $MRPACK_URL..."
          curl -L -o "client.mrpack" "$MRPACK_URL"
          
          mkdir -p mrpack-contents
          unzip -o client.mrpack -d mrpack-contents

      - name: Setup output directories
        run: |
          OUTPUT_DIR="${PACK_NAME}-Server-${VERSION}"
          mkdir -p "${OUTPUT_DIR}/mods"
          mkdir -p "${OUTPUT_DIR}/config"
          mkdir -p "${OUTPUT_DIR}/defaultconfigs"
          echo "OUTPUT_DIR=${OUTPUT_DIR}" >> $GITHUB_ENV

      - name: Download server mods
        run: |
          # Build client-only patterns regex
          CLIENT_ONLY=$(grep -v '^#' scripts/client-only-mods.txt | grep -v '^$' | sed 's/\*/.*/g' | tr '\n' '|' | sed 's/|$//')
          
          DOWNLOADED=0
          SKIPPED=0
          
          if [ -f "mrpack-contents/modrinth.index.json" ]; then
            jq -r '.files[] | select(.path | startswith("mods/")) | "\(.path)|\(.downloads[0])"' mrpack-contents/modrinth.index.json > mod_list.txt
            
            while IFS='|' read -r path url; do
              filename=$(basename "$path")
              if echo "$filename" | grep -qiE "$CLIENT_ONLY"; then
                echo "‚è≠ SKIP: $filename"
                ((SKIPPED++))
              else
                echo "‚¨á Downloading: $filename"
                curl -sL -o "${OUTPUT_DIR}/mods/${filename}" "$url" || echo "Failed: $filename"
                ((DOWNLOADED++))
              fi
            done < mod_list.txt
          fi
          
          # Copy overrides
          if [ -d "mrpack-contents/overrides/mods" ]; then
            for mod in mrpack-contents/overrides/mods/*.jar; do
              [ -f "$mod" ] || continue
              filename=$(basename "$mod")
              if echo "$filename" | grep -qiE "$CLIENT_ONLY"; then
                echo "‚è≠ SKIP override: $filename"
                ((SKIPPED++))
              else
                cp "$mod" "${OUTPUT_DIR}/mods/"
                ((DOWNLOADED++))
              fi
            done
          fi
          
          echo "DOWNLOADED=$DOWNLOADED" >> $GITHUB_ENV
          echo "SKIPPED=$SKIPPED" >> $GITHUB_ENV

      - name: Copy configs
        run: |
          # Copy repo configs first
          rsync -av --exclude='fancymenu*' --exclude='drippyloadingscreen*' --exclude='xaero*' --exclude='journeymap*' --exclude='oculus*' config/ "${OUTPUT_DIR}/config/"
          
          # Copy defaultconfigs
          [ -d "defaultconfigs" ] && cp -r defaultconfigs/* "${OUTPUT_DIR}/defaultconfigs/"
          
          # Merge mrpack config overrides (priority)
          if [ -d "mrpack-contents/overrides/config" ]; then
            rsync -av --exclude='fancymenu*' --exclude='drippyloadingscreen*' --exclude='xaero*' --exclude='journeymap*' --exclude='oculus*' mrpack-contents/overrides/config/ "${OUTPUT_DIR}/config/"
          fi

      - name: Install Forge server
        run: |
          cd "${OUTPUT_DIR}"
          FORGE_INSTALLER="forge-${MINECRAFT_VERSION}-${FORGE_VERSION}-installer.jar"
          curl -LO "https://maven.minecraftforge.net/net/minecraftforge/forge/${MINECRAFT_VERSION}-${FORGE_VERSION}/${FORGE_INSTALLER}"
          java -jar "${FORGE_INSTALLER}" --installServer
          rm -f "${FORGE_INSTALLER}" installer.log *.log
          cd ..

      - name: Create start scripts
        run: |
          # Linux
          cat > "${OUTPUT_DIR}/start.sh" << 'EOF'
#!/bin/bash
# OKICRAFT Server Start Script
MIN_RAM="${MIN_RAM:-4G}"
MAX_RAM="${MAX_RAM:-8G}"
java -Xms${MIN_RAM} -Xmx${MAX_RAM} -XX:+UseG1GC -XX:+ParallelRefProcEnabled -XX:MaxGCPauseMillis=200 -XX:+UnlockExperimentalVMOptions -XX:+DisableExplicitGC -XX:+AlwaysPreTouch -XX:G1NewSizePercent=30 -XX:G1MaxNewSizePercent=40 -XX:G1HeapRegionSize=8M -XX:G1ReservePercent=20 -XX:G1HeapWastePercent=5 -XX:G1MixedGCCountTarget=4 -XX:InitiatingHeapOccupancyPercent=15 -XX:G1MixedGCLiveThresholdPercent=90 -XX:G1RSetUpdatingPauseTimePercent=5 -XX:SurvivorRatio=32 -XX:+PerfDisableSharedMem -XX:MaxTenuringThreshold=1 -Dusing.aikars.flags=https://mcflags.emc.gs @user_jvm_args.txt @libraries/net/minecraftforge/forge/*/unix_args.txt nogui "$@"
EOF
          chmod +x "${OUTPUT_DIR}/start.sh"
          
          # Windows
          cat > "${OUTPUT_DIR}/start.bat" << 'EOF'
@echo off
title OKICRAFT Server
set MIN_RAM=4G
set MAX_RAM=8G
java -Xms%MIN_RAM% -Xmx%MAX_RAM% -XX:+UseG1GC -XX:+ParallelRefProcEnabled -XX:MaxGCPauseMillis=200 -XX:+UnlockExperimentalVMOptions -XX:+DisableExplicitGC -XX:+AlwaysPreTouch -XX:G1NewSizePercent=30 -XX:G1MaxNewSizePercent=40 -XX:G1HeapRegionSize=8M -XX:G1ReservePercent=20 -XX:G1HeapWastePercent=5 -XX:G1MixedGCCountTarget=4 -XX:InitiatingHeapOccupancyPercent=15 -XX:G1MixedGCLiveThresholdPercent=90 -XX:G1RSetUpdatingPauseTimePercent=5 -XX:SurvivorRatio=32 -XX:+PerfDisableSharedMem -XX:MaxTenuringThreshold=1 -Dusing.aikars.flags=https://mcflags.emc.gs @user_jvm_args.txt @libraries/net/minecraftforge/forge/*/win_args.txt nogui %*
pause
EOF
          
          echo "# Add custom JVM arguments here" > "${OUTPUT_DIR}/user_jvm_args.txt"
          echo "eula=false" > "${OUTPUT_DIR}/eula.txt"

      - name: Create Archive
        run: |
          ARCHIVE="${PACK_NAME}-Server-${VERSION}.zip"
          zip -r "$ARCHIVE" "${OUTPUT_DIR}"
          echo "ARCHIVE=$ARCHIVE" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          name: OKICRAFT v${{ env.VERSION }}
          files: ${{ env.ARCHIVE }}
          body: |
            ## üöÄ Auto-Generated Release
            
            Synced from [Modrinth](https://modrinth.com/modpack/${{ env.MODRINTH_PROJECT_SLUG }}/version/${{ env.VERSION }}).
            
            ### üñ•Ô∏è Server Pack
            - **Mods:** ${{ env.DOWNLOADED }}
            - **Excluded:** ${{ env.SKIPPED }} (client-only)
            - **Forge:** ${{ env.FORGE_VERSION }}
            
            Download `OKICRAFT-Server-${{ env.VERSION }}.zip` below.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
